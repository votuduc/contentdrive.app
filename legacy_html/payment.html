<!DOCTYPE html>
<html lang="en">

<head>
  <!--Google Analytics-->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ER35MV56D3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-ER35MV56D3');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Secure Checkout - ContentDrive</title>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            google: { blue: '#4285F4', red: '#DB4437', yellow: '#F4B400', green: '#0F9D58' },
          },
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
            display: ['Google Sans', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-50 font-sans text-gray-900 h-screen flex flex-col">

  <!-- Minimal Header -->
  <header class="bg-white border-b border-gray-200 py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <a href="index.html" class="flex items-center gap-2 group">
        <i class="fas fa-arrow-left text-gray-400 group-hover:text-gray-600 transition-colors"></i>
        <span class="text-gray-500 font-medium group-hover:text-gray-700 transition-colors">Back to Home</span>
      </a>
      <img src="images/logo/logo_contentdrive_400x133.png" alt="ContentDrive" class="h-8 md:h-10">
      <div class="w-24"></div> <!-- Spacer for centering -->
    </div>
  </header>

  <!-- Main Checkout Area -->
  <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-8 md:gap-12">

      <!-- LEFT COLUMN: Order Summary -->
      <div class="md:col-span-7 space-y-6">

        <!-- Plan Details Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8">
          <h2 class="text-xl font-display font-bold text-gray-900 mb-6 flex items-center">
            <span
              class="bg-blue-50 text-google-blue w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">1</span>
            Order Summary
          </h2>

          <div class="flex justify-between items-start border-b border-gray-100 pb-6 mb-6">
            <div>
              <h3 id="plan-name" class="text-2xl font-bold text-gray-900 mb-1">Loading Plan...</h3>
              <p class="text-gray-500 text-sm">Monthly Subscription</p>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-gray-900" id="plan-price">$0</div>
              <div class="text-gray-400 text-sm">/month</div>
            </div>
          </div>

          <!-- Included Features (Dynamic) -->
          <div class="mb-8">
            <h4 class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-4">What's Included</h4>
            <ul class="space-y-3" id="feature-list">
              <!-- Features injected via JS -->
            </ul>
          </div>

          <!-- Discount Section -->
          <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Discount Code</label>
            <div class="flex gap-2">
              <input type="text" id="discount-code" placeholder="Enter code"
                class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-google-blue outline-none bg-white">
              <button id="apply-discount"
                class="bg-gray-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-800 transition-colors">Apply</button>
            </div>
            <p id="discount-message" class="text-sm mt-2 font-medium hidden"></p>
          </div>

          <!-- Total Row -->
          <div class="flex justify-between items-center mt-6 pt-6 border-t border-gray-100">
            <span class="font-bold text-gray-700">Total due today</span>
            <span class="text-2xl font-bold text-google-green" id="total-price">$0.00</span>
          </div>
        </div>

        <!-- Trust Badges -->
        <div class="flex justify-center gap-6 text-gray-400 grayscale opacity-70">
          <div class="flex items-center gap-2"><i class="fas fa-lock"></i> SSL Secure</div>
          <div class="flex items-center gap-2"><i class="fas fa-shield-alt"></i> Data Privacy</div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Payment -->
      <div class="md:col-span-5">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 md:p-8 sticky top-4">
          <h2 class="text-xl font-display font-bold text-gray-900 mb-6 flex items-center">
            <span
              class="bg-blue-50 text-google-blue w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm">2</span>
            Secure Payment
          </h2>

          <p class="text-gray-600 text-sm mb-6">Complete your subscription safely with PayPal. You can cancel at any
            time.</p>

          <!-- PayPal Container -->
          <div id="paypal-button-container" class="w-full"></div>

          <div class="mt-6 text-center">
            <p class="text-xs text-gray-400 leading-relaxed">
              By proceeding, you agree to our <a href="terms-and-conditions.html"
                class="underline hover:text-gray-600">Terms of Service</a>.
              <br>Your license key will be sent to your PayPal email immediately after payment.
            </p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Scripts -->
  <script
    src="https://www.paypal.com/sdk/js?client-id=AXxPC5qauR2oKGWOtsVi9Wy4LsMfmRSSzhmFtaaKSIflM6m2Du_-0mDyfgItdvHfTPAtst_bPvIhmHAu&vault=true&intent=subscription"
    data-sdk-integration-source="button-factory"></script>
  <script>
    // --- CONFIGURATION ---
    const PLANS = {
      "PRO": {
        name: "Pro Plan",
        price: 29.00,
        id: "P-6GK30767G94091318NEA5GVY",
        features: ["Up to 100 briefs/month", "Automated Dispatch", "5 Article Writer Credits/mo", "Priority Support"]
      },
      "BUSINESS": {
        name: "Business Plan",
        price: 99.00,
        id: "P-9XH43012K32457045NEA5HLQ",
        features: ["Unlimited AI Briefs", "10 Article Writer Credits/mo", "5 Digital Asset Credits/mo", "Team Collaboration (5 Users)"]
      }
    };

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzS4QaCaAr0-FdqP9E08awc2zHzQe5CLDv2MyvpQIbIDS0EjfyfnDCVmxBCbbgNrDPL/exec';

    // --- STATE ---
    let selectedPlanKey = new URLSearchParams(window.location.search).get('plan');

    // Normalize
    if (selectedPlanKey) selectedPlanKey = selectedPlanKey.toUpperCase();

    // Default if missing or invalid
    if (!selectedPlanKey || !PLANS[selectedPlanKey]) {
      selectedPlanKey = 'PRO';
    }

    let currentPlan = PLANS[selectedPlanKey];
    let discount = { percentage: 0, code: "" };

    // --- INITIALIZATION ---
    function init() {
      renderPlanDetails();
      renderPayPal();
    }

    function renderPlanDetails() {
      document.getElementById('plan-name').textContent = currentPlan.name;
      document.getElementById('plan-price').textContent = '$' + currentPlan.price;

      // Features
      const list = document.getElementById('feature-list');
      list.innerHTML = currentPlan.features.map(f =>
        `<li class="flex items-center text-sm text-gray-600"><i class="fas fa-check text-green-500 mr-3"></i> ${f}</li>`
      ).join('');

      updateTotal();
    }

    function updateTotal() {
      let finalPrice = currentPlan.price;
      if (discount.percentage > 0) {
        const amountOff = (currentPlan.price * discount.percentage) / 100;
        finalPrice = currentPlan.price - amountOff;
      }
      document.getElementById('total-price').textContent = '$' + finalPrice.toFixed(2);
    }

    // --- DISCOUNT LOGIC ---
    document.getElementById('apply-discount').addEventListener('click', async () => {
      const codeInput = document.getElementById('discount-code');
      const msg = document.getElementById('discount-message');
      const btn = document.getElementById('apply-discount');
      const code = codeInput.value.trim();

      if (!code) return;

      btn.textContent = '...';
      btn.disabled = true;
      msg.classList.add('hidden');

      try {
        const response = await fetch(`${SCRIPT_URL}?discountCode=${code}`);
        const data = await response.json();

        if (data.discountPercentage > 0) {
          discount.percentage = data.discountPercentage;
          discount.code = code;
          msg.textContent = `Success! ${data.discountPercentage}% off applied.`;
          msg.className = "text-sm mt-2 font-medium text-green-600 block";
          updateTotal();
          // Re-render to update subscription creation logic
          renderPayPal();
        } else {
          discount.percentage = 0;
          msg.textContent = "Invalid code.";
          msg.className = "text-sm mt-2 font-medium text-red-500 block";
          updateTotal();
        }
      } catch (e) {
        console.error(e);
        msg.textContent = "Error checking code.";
        msg.className = "text-sm mt-2 font-medium text-red-500 block";
      } finally {
        btn.textContent = 'Apply';
        btn.disabled = false;
      }
    });

    // --- PAYPAL LOGIC ---
    function renderPayPal() {
      document.getElementById('paypal-button-container').innerHTML = '';

      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'blue',
          layout: 'vertical',
          label: 'subscribe'
        },
        createSubscription: function (data, actions) {
          const subDetails = { 'plan_id': currentPlan.id };

          // Handle Discount
          if (discount.percentage > 0) {
            const finalPrice = (currentPlan.price * (1 - discount.percentage / 100)).toFixed(2);
            subDetails.plan = {
              billing_info: {
                outstanding_balance: { value: '0.00', currency_code: 'USD' },
                cycle_executions: [{
                  tenure_type: 'TRIAL',
                  sequence: 1,
                  cycles_completed: 0,
                  cycles_remaining: 1,
                  total_cycles: 1,
                  pricing_scheme: {
                    fixed_price: { value: finalPrice, currency_code: 'USD' }
                  }
                }]
              }
            };
            subDetails.custom_id = `DISCOUNT:${discount.code}`;
          }
          return actions.subscription.create(subDetails);
        },
        onApprove: function (data) {
          // Redirect to Thank You Page
          window.location.href = "thank-you.html";
        },
        onError: function (err) {
          alert('Something went wrong. Please try again.');
          console.error(err);
        }
      }).render('#paypal-button-container');
    }

    init();
  </script>
</body>

</html>